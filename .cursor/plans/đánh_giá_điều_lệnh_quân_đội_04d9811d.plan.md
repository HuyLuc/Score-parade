---
name: Đánh giá điều lệnh quân đội
overview: Xây dựng hệ thống đánh giá điều lệnh quân đội sử dụng computer vision để phân tích và chấm điểm động tác của từng cá nhân trong nhóm (6-20 người), hỗ trợ cả real-time và batch processing trên môi trường local.
todos: []
---

---
name: Đánh giá điều lệnh quân đội
overview: Xây dựng hệ thống đánh giá điều lệnh quân đội sử dụng computer vision để phân tích và chấm điểm động tác của từng cá nhân trong nhóm (6-20 người), hỗ trợ cả real-time và batch processing trên môi trường local.
todos: []
---

# Kế hoạch triển khai hệ thống đánh giá điều lệnh quân đội

## Tổng quan công nghệ

**Stack công nghệ chính:**

- **Pose Estimation**: RTMPose (khuyến nghị) hoặc YOLOv8-Pose
- **Multi-person Tracking**: OC-SORT hoặc ByteTrack
- **Video Processing**: OpenCV, FFmpeg
- **Signal Processing**: NumPy, SciPy, Savitzky-Golay filter
- **Temporal Alignment**: Dynamic Time Warping (DTW) - dtw-python
- **Visualization**: OpenCV, Matplotlib
- **Framework**: Python 3.8+

**Tham khảo:**

- RTMPose: https://github.com/open-mmlab/mmpose
- OC-SORT: https://github.com/noahcao/OC_SORT
- DTW: https://github.com/DynamicTimeWarping/dtw-python

## Cấu trúc dự án

```
Score-parade/
├── data/
│   ├── golden_template/          # Video và skeleton mẫu chuẩn
│   ├── input_videos/             # Video đầu vào cần đánh giá
│   ├── output/                   # Video và báo cáo kết quả
│   └── models/                   # Model weights (RTMPose, etc.)
├── src/
│   ├── step1_golden_template.py  # Bước 1: Tạo video mẫu chuẩn
│   ├── step2_feature_extraction.py # Bước 2: Trích xuất đặc điểm
│   ├── step3_process_video.py    # Bước 3: Xử lý video mới
│   ├── step4_temporal_alignment.py # Bước 4: Căn chỉnh thời gian
│   ├── step5_geometric_matching.py # Bước 5: So sánh hình học
│   ├── step6_scoring.py          # Bước 6: Tính điểm
│   ├── step7_visualization.py    # Bước 7: Xuất lỗi
│   ├── utils/
│   │   ├── pose_estimation.py    # Wrapper RTMPose/YOLO-Pose
│   │   ├── tracking.py           # Multi-person tracking
│   │   ├── geometry.py           # Tính toán góc, vector
│   │   ├── smoothing.py          # Làm mượt dữ liệu
│   │   └── video_utils.py        # Xử lý video cơ bản
│   └── config.py                 # Cấu hình toàn dự án
├── notebooks/                    # Jupyter notebooks để thử nghiệm
├── requirements.txt
├── README.md
└── pipeline.md
```

## Chi tiết từng bước

### BƯỚC 1: TẠO VIDEO MẪU CHUẨN (GOLDEN TEMPLATE)

**Mục tiêu**: Tạo bộ dữ liệu chuẩn từ video điều lệnh hoàn hảo nhất.

**Công việc thủ công cần làm:**

1. Quay/chuẩn bị video mẫu chuẩn (1 người hoặc 1 nhóm nhỏ)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Độ phân giải tối thiểu: 720p
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Frame rate: 30fps trở lên
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Điều kiện ánh sáng tốt, góc quay rõ ràng
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Video dài ít nhất 1 chu kỳ điều lệnh hoàn chỉnh (ví dụ: 10-30 giây)

2. Lưu video vào `data/golden_template/golden_video.mp4`

**Công việc code:**

- Cài đặt RTMPose hoặc YOLOv8-Pose
- Trích xuất skeleton từ video mẫu
- Lưu skeleton data (JSON hoặc pickle) vào `data/golden_template/golden_skeleton.pkl`
- Tạo visualization để kiểm tra skeleton có đúng không

**File cần tạo**: `src/step1_golden_template.py`

**Output**:

- `data/golden_template/golden_skeleton.pkl` (skeleton data)
- `data/golden_template/golden_skeleton_vis.mp4` (video visualization)

---

### BƯỚC 2: TRÍCH XUẤT ĐẶC ĐIỂM HÌNH HỌC (FEATURE EXTRACTION)

**Mục tiêu**: Tính toán các đặc điểm hình học từ skeleton mẫu.

**Công việc thủ công cần làm:**

1. Xác định các điểm khớp quan trọng cho điều lệnh:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Tay: vai, khuỷu tay, cổ tay
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Chân: hông, đầu gối, mắt cá chân
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Thân: đầu, cổ, vai, hông

2. Xác định các góc và khoảng cách cần đo:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Góc tay (vai-khuỷu tay-cổ tay)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Góc chân (hông-đầu gối-mắt cá)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Độ cao tay so với vai
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Độ cao chân so với mặt đất
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Góc nghiêng thân người
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Nhịp bước (steps per minute)

**Công việc code:**

- Đọc skeleton từ Bước 1
- Tính toán các góc khớp (sử dụng vector và dot product)
- Tính độ cao tay/chân
- Phát hiện nhịp bước (keyframe detection)
- Làm mượt dữ liệu bằng Savitzky-Golay filter
- Lưu profile chuẩn vào `data/golden_template/golden_profile.json`

**File cần tạo**: `src/step2_feature_extraction.py`, `src/utils/geometry.py`, `src/utils/smoothing.py`

**Output**:

- `data/golden_template/golden_profile.json` (profile chuẩn với các giá trị: góc tay, góc chân, nhịp bước, etc.)

---

### BƯỚC 3: XỬ LÝ VIDEO MỚI (TÂN BINH / NHÓM)

**Mục tiêu**: Xử lý video đầu vào, trích skeleton cho nhiều người.

**Công việc thủ công cần làm:**

1. Chuẩn bị video đầu vào:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Đặt video vào `data/input_videos/`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Đảm bảo format tương thích (MP4, AVI)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Ghi chú số lượng người trong video

2. Kiểm tra chất lượng video (độ phân giải, ánh sáng)

**Công việc code:**

- Load video và trích skeleton cho từng frame
- Multi-person tracking (OC-SORT hoặc ByteTrack)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Gán ID cố định cho mỗi người qua các frame
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Xử lý trường hợp người bị che khuất
- Làm mượt skeleton data
- Tách các pha chuyển động (keyframe detection)
- Lưu skeleton data cho từng người: `data/output/{video_name}/person_{id}_skeleton.pkl`

**File cần tạo**: `src/step3_process_video.py`, `src/utils/tracking.py`

**Output**:

- Skeleton data cho từng người trong video
- Tracking IDs ổn định

---

### BƯỚC 4: CĂN CHỈNH THỜI GIAN (TEMPORAL ALIGNMENT)

**Mục tiêu**: Khớp nhịp và pha chuyển động giữa video mẫu và video mới.

**Công việc thủ công cần làm:**

1. Xác định các điểm mốc quan trọng trong chu kỳ điều lệnh:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Bước chân trái đầu tiên
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Bước chân phải đầu tiên
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Điểm cao nhất của tay
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Điểm thấp nhất của chân

2. Đánh dấu các keyframe trong video mẫu (nếu cần)

**Công việc code:**

- Implement Dynamic Time Warping (DTW)
- Căn chỉnh timeline giữa golden template và video mới
- Xử lý trường hợp video mới dài/ngắn hơn mẫu
- Tạo mapping function: frame_new = f(frame_golden)

**File cần tạo**: `src/step4_temporal_alignment.py`

**Output**:

- Mapping table giữa frames của golden và video mới
- Aligned skeleton sequences

---

### BƯỚC 5: SO SÁNH HÌNH HỌC (GEOMETRIC MATCHING)

**Mục tiêu**: Đo sai lệch giữa động tác thực tế và mẫu chuẩn.

**Công việc thủ công cần làm:**

1. Xác định ngưỡng sai lệch cho từng yếu tố:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Góc tay: ±5° là chấp nhận được?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Góc chân: ±3°?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Độ cao tay: ±10cm?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Độ cao chân: ±5cm?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Góc đầu: ±2°?

**Công việc code:**

- So sánh góc khớp (tính difference)
- So sánh độ cao tay/chân
- So sánh vector hướng (cosine similarity)
- Tính độ ổn định thân người (variance của vị trí hông/cổ)
- Tính sai lệch nhịp bước
- Lưu error metrics cho từng frame và từng người

**File cần tạo**: `src/step5_geometric_matching.py`

**Output**:

- Error metrics cho từng người: `data/output/{video_name}/person_{id}_errors.json`
- Chi tiết lỗi theo frame: góc tay lệch, chân thấp, đầu cúi, etc.

---

### BƯỚC 6: TÍNH ĐIỂM

**Mục tiêu**: Quy đổi sai lệch thành điểm số (0-10).

**Công việc thủ công cần làm:**

1. Xác định trọng số cho từng yếu tố:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Kỹ thuật tay: 30%
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Kỹ thuật chân: 30%
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Nhịp bước: 20%
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Ổn định thân người: 20%

2. Xác định công thức tính điểm:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Ví dụ: Điểm = 10 - (tổng sai lệch có trọng số)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Hoặc: Điểm = 10 * exp(-sai_lệch/ngưỡng)

**Công việc code:**

- Load error metrics từ Bước 5
- Áp dụng công thức tính điểm với trọng số
- Tính điểm tổng và điểm từng yếu tố
- Lưu kết quả: `data/output/{video_name}/person_{id}_score.json`

**File cần tạo**: `src/step6_scoring.py`

**Output**:

- Điểm số cho từng người (0-10)
- Breakdown điểm theo từng yếu tố

---

### BƯỚC 7: XUẤT LỖI CHO HUẤN LUYỆN VIÊN

**Mục tiêu**: Tạo báo cáo trực quan về lỗi sai.

**Công việc thủ công cần làm:**

1. Xác định format báo cáo mong muốn:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Video overlay với skeleton và annotations?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Báo cáo text/JSON?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Dashboard web?

2. Xác định màu sắc và ký hiệu:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Màu đỏ: lỗi nghiêm trọng
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Màu vàng: lỗi nhẹ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Màu xanh: đúng chuẩn

**Công việc code:**

- Vẽ skeleton lên video gốc
- Overlay thông tin lỗi (text, arrows, angles)
- Tạo báo cáo text/JSON tổng hợp
- Export video kết quả: `data/output/{video_name}/person_{id}_annotated.mp4`
- Tạo báo cáo tổng hợp: `data/output/{video_name}/report.html` hoặc `report.json`

**File cần tạo**: `src/step7_visualization.py`

**Output**:

- Video annotated cho từng người
- Báo cáo tổng hợp (HTML/JSON)
- Summary: "Người 1: 8.5/10 - Tay thấp 3°, Chân đưa thấp 5cm"

---

## Workflow tổng thể

**Batch Processing:**

```python
# main.py
1. Load golden template (Bước 1, 2)
2. For each video in input_videos:
   a. Process video (Bước 3)
   b. For each person:
   - Temporal alignment (Bước 4)
   - Geometric matching (Bước 5)
   - Scoring (Bước 6)
   c. Visualization (Bước 7)
```

**Real-time Processing:**

- Sử dụng webcam hoặc RTSP stream
- Xử lý frame-by-frame với buffer
- Hiển thị kết quả real-time

## Các bước setup ban đầu

1. **Cài đặt môi trường Python**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Python 3.8+
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Virtual environment
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Install dependencies từ `requirements.txt`

2. **Download models**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - RTMPose model weights
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - OC-SORT weights (nếu cần)

3. **Cấu hình**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Chỉnh `src/config.py` với các tham số:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Độ phân giải video
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Số người tối đa
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Ngưỡng sai lệch
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Trọng số tính điểm

## Lưu ý quan trọng

- **Bước 1-2 chỉ làm 1 lần** để tạo golden template
- **Bước 3-7** sẽ chạy cho mỗi video đầu vào mới
- Mỗi bước nên có script riêng để dễ debug và test
- Lưu intermediate results để tránh phải chạy lại từ đầu
- Test với video ngắn trước, sau đó scale lên video dài